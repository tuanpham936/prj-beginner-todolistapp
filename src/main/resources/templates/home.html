<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>ToDo List</title>
  <link rel="stylesheet" href="/css/home.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body>
<div class="todo-container">
  <!-- Tabs -->
  <div class="tabs">
    <button class="tab-btn" data-tab="todo" th:classappend="${activeTab == 'todo'} ? ' active'">ToDo</button>
    <button class="tab-btn" data-tab="done" th:classappend="${activeTab == 'done'} ? ' active'">Done</button>
    <button class="tab-btn" data-tab="cancel" th:classappend="${activeTab == 'cancel'} ? ' active'">Cancel</button>
  </div>

  <!-- Search -->
  <form action="/search" method="post" class="search-bar">
    <input type="hidden" name="activeTab" th:value="${activeTab}" id="search-tab">
    <input type="text" id="search-input" placeholder="Search..." name="keyword">
    <button type="submit" id="search-btn">Search</button>
  </form>

  <!-- Content -->
  <div class="tab-content" id="todo" th:style="${activeTab != 'todo'} ? 'display:none' : 'display:block'">
    <table>
        <thead>
            <tr>
                <th>Done</th>
                <th class="sortable" data-sort-key="task" data-order="asc">Task <i class="fa fa-sort-alpha-asc" aria-hidden="true"></i></th>
                <th class="sortable" data-sort-key="date" data-order="asc">Date <i class="fa fa-sort-numeric-asc" aria-hidden="true"></i></th>
                <th>Edit</th>
                <th>Cancel</th>
            </tr>
        </thead>
      <tbody>
        <tr th:each="item : ${todo}" th:data-exp="${item.exp}">
          <td>
              <button type="button" class="checkbox-btn" th:data-id="${item.id}">‚úîÔ∏è</button>
          </td>
          <td th:text="${item.task}">T√™n</td>
          <td th:text="${item.exp}">2024-01-01</td>
          <td><button class="edit-btn">‚úèÔ∏è</button></td>
          <td>
              <button type="button" class="delete-btn" th:data-id="${item.id}" data-state="remove">üóëÔ∏è</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="tab-content" id="done" th:style="${activeTab != 'done'} ? 'display:none' : 'display:block'">
    <table>
        <thead>
            <tr>
                <th>Task</th>
                <th>Date</th>
                <th>Rollback</th>
            </tr>
        </thead>
      <tbody>
        <tr th:each="item : ${done}">
          <td th:text="${item.task}">T√™n</td>
          <td th:text="${item.exp}">2024-01-01</td>
          <td>
              <button type="button" class="done-rollback-btn rollback-btn" th:data-id="${item.id}">‚Ü©Ô∏è</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="tab-content" id="cancel" th:style="${activeTab != 'cancel'} ? 'display:none' : 'display:block'">
    <table>
        <thead>
            <tr>
                <th>Task</th>
                <th>Date</th>
                <th>Rollback</th>
            </tr>
        </thead>
      <tbody>
        <tr th:each="item : ${cancel}">
          <td th:text="${item.task}">T√™n</td>
          <td th:text="${item.exp}">2024-01-01</td>
          <td>
              <button type="button" class="cancel-rollback-btn rollback-btn" th:data-id="${item.id}">‚Ü©Ô∏è</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Bottom Buttons -->
  <div class="bottom-bar">
    <button id="open-modal-btn">Add ToDo</button>
    <button id="clear-btn">Clear This Tab</button>
  </div>
</div>

<div id="todo-modal" class="modal">
  <div class="modal-content">
    <span class="close-btn">&times;</span>
    <h2>üìù Add New Task</h2>
    <form action="/todo/add" method="post" id="todo-form">
      <input type="hidden" name="id" value="">
      <label for="task">Task Name:</label>
      <input type="text" id="taskName" name="task" required>

      <label for="taskDate">Date:</label>
      <input type="date" id="date" name="exp" required>

      <button type="submit" class="submit-btn">Submit</button>
    </form>
  </div>
</div>

<script>
  const modal = document.getElementById('todo-modal');
  const openBtn = document.getElementById('open-modal-btn');
  const closeBtn = document.querySelector('.close-btn');

  openBtn.onclick = () => modal.style.display = 'block';
  closeBtn.onclick = () => modal.style.display = 'none';
  window.onclick = (e) => {
    if (e.target == modal) modal.style.display = 'none';
  };

  const form = document.getElementById('todo-form');
  form.addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(form);
    const data = {
      id: "",
      task: formData.get('task'),
      exp: formData.get('exp') 
    };

    fetch('/todo/add', {
      method: 'POST',
      headers: {
          'Content-Type': 'application/json'
      }, 
      body: JSON.stringify(data)
    })
    .then(response => {
        location.reload();
    })
    .catch(error => {
      alert("C√≥ l·ªói x·∫£y ra");
      console.error(error);
    });
  });

  document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
      document.getElementById('search-tab').value = btn.dataset.tab;
      btn.classList.add('active');
      document.getElementById(btn.dataset.tab).style.display = 'block';
  });
  });

  document.querySelectorAll('.checkbox-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.getAttribute('data-id');
      fetch('/todo/done/' + id, {
        method: 'DELETE',
        body: null
      })
      .then(response => response.status)
      .then(result => {
        location.reload();
      })
      .catch(error => {
        location.reload();
      });
    });
  });

  document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        if (btn.getAttribute('data-state') === 'remove') {
          const id = btn.getAttribute('data-id');
          fetch('/todo/cancel/' + id, {
            method: 'DELETE',
            body: null
          })
          .then(response => response.status)
          .then(result => {
            location.reload();
          })
          .catch(error => {
            location.reload();
          });
        }
      })
  });

  document.querySelectorAll('.done-rollback-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.getAttribute('data-id');
      fetch('/done/rollback/' + id, {
        method: 'DELETE',
        body: null
      })
      .then(response => response.status)
      .then(result => {
        location.reload();
      })
      .catch(error => {
        location.reload();
      });
    });
  });
  
  document.querySelectorAll('.cancel-rollback-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.getAttribute('data-id');
      fetch('/cancel/rollback/' + id, {
        method: 'DELETE',
        body: null
      })
      .then(response => response.status)
      .then(result => {
        location.reload();
      })
      .catch(error => {
        location.reload();
      });
    });
  });

  document.querySelectorAll('.edit-btn').forEach(editBtn => {
    editBtn.addEventListener('click', function () {
      const row = this.closest('tr');
      const taskCell = row.children[1];
      const dateCell = row.children[2];
      const cancelBtn = row.querySelector('.delete-btn');
      const id = cancelBtn.dataset.id;

      const isEditing = taskCell.querySelector('input') !== null;

      if (!isEditing) {
        // Chuy·ªÉn sang edit mode
        const oldTask = taskCell.textContent.trim();
        const oldDate = dateCell.textContent.trim();

        taskCell.innerHTML = `<input type="text" value="${oldTask}" class="task-input">`;
        dateCell.innerHTML = `<input type="date" value="${oldDate}" class="date-input">`;

        editBtn.textContent = '‚úÖ';
        cancelBtn.textContent = '‚ùå';
        cancelBtn.setAttribute('data-state', 'cancel');

        // G·∫Øn s·ª± ki·ªán cho cancelBtn ƒë·ªÉ h·ªßy
        cancelBtn.onclick = () => {
          if (cancelBtn.getAttribute('data-state') === 'cancel') {
            taskCell.textContent = oldTask;
            dateCell.textContent = oldDate;
            editBtn.textContent = '‚úèÔ∏è';
            cancelBtn.textContent = 'üóëÔ∏è';
            cancelBtn.setAttribute('data-state', 'remove');
          }
        };

        row.addEventListener('keydown', function (e) {
          if (e.key === 'Enter') submitEdit();
        });

      } 
      else {
        submitEdit();
      }

      function submitEdit() {
        const updatedTask = taskCell.querySelector('input').value;
        const updatedDate = dateCell.querySelector('input').value;
        
        taskCell.textContent = updatedTask;
        dateCell.textContent = updatedDate;
        editBtn.textContent = '‚úèÔ∏è';
        cancelBtn.textContent = 'üóëÔ∏è';
        cancelBtn.setAttribute('data-state', 'remove');

        row.setAttribute('data-exp', updatedDate);

        const expStr = updatedDate;
        const expDate = new Date(expStr);
        const today = new Date();

        // Reset gi·ªù v·ªÅ 0 ƒë·ªÉ so s√°nh ch√≠nh x√°c theo ng√†y
        today.setHours(0, 0, 0, 0);
        expDate.setHours(0, 0, 0, 0);

        const timeDiff = expDate - today;
        const daysDiff = timeDiff / (1000 * 60 * 60 * 24);

        if (daysDiff < 0) {
          // Qu√° h·∫°n
          row.style.backgroundColor = '#ffdddd'; // ƒë·ªè nh·∫°t
        } else if (daysDiff <= 7) {
          // Tr∆∞·ªõc h·∫°n 7 ng√†y
          row.style.backgroundColor = '#fffacc'; // v√†ng nh·∫°t
        }
        else {
          row.style.backgroundColor = '#f0f0f0';
        }

        fetch('/todo/update', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            id: id,
            task: updatedTask,
            exp: updatedDate
          })
        }).then(res => {
          if (res.ok) {
          } else {
            alert("‚ùå Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t");
          }
        }).catch(err => {
          alert("‚ùå L·ªói k·∫øt n·ªëi");
          console.error(err);
        });
      }
    });
  });

  document.getElementById('clear-btn').addEventListener('click', () => {
    const tab = document.querySelector('.active').getAttribute('data-tab');

    fetch('/clear/' + tab, {
      method: 'DELETE',
      body: null
    })
    .then(response => response.status)
    .then(result => {
      location.reload();
    })
    .catch(error => {
      location.reload();
    });
  });

  document.querySelectorAll('tr[data-exp]').forEach(row => {
    const expStr = row.dataset.exp;
    const expDate = new Date(expStr);
    const today = new Date();

    // Reset gi·ªù v·ªÅ 0 ƒë·ªÉ so s√°nh ch√≠nh x√°c theo ng√†y
    today.setHours(0, 0, 0, 0);
    expDate.setHours(0, 0, 0, 0);

    const timeDiff = expDate - today;
    const daysDiff = timeDiff / (1000 * 60 * 60 * 24);

    if (daysDiff < 0) {
      // Qu√° h·∫°n
      row.style.backgroundColor = '#ffdddd'; // ƒë·ªè nh·∫°t
    } else if (daysDiff <= 7) {
      // Tr∆∞·ªõc h·∫°n 7 ng√†y
      row.style.backgroundColor = '#fffacc'; // v√†ng nh·∫°t
    }
    else {
      row.style.backgroundColor = '#f0f0f0';
    }
  });

  function sortTableBy(key, order) {
    const tbody = document.querySelector('#todo tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));

    const keyIndex = {
      task: 1,
      date: 2
    };

    const colIndex = keyIndex[key];
    const isDate = key === 'date';

    rows.sort((a, b) => {
      let valA = a.children[colIndex].textContent.trim();
      let valB = b.children[colIndex].textContent.trim();

      if (isDate) {
        valA = new Date(valA);
        valB = new Date(valB);
      }

      return order === 'asc'
        ? (valA > valB ? 1 : valA < valB ? -1 : 0)
        : (valA < valB ? 1 : valA > valB ? -1 : 0);
    });

    rows.forEach(row => tbody.appendChild(row));
  }

  document.querySelectorAll('.sortable').forEach(th => {
    th.style.cursor = 'pointer';
    th.addEventListener('click', () => {
      const key = th.dataset.sortKey;
      const currentOrder = th.dataset.order || 'asc';
      const newOrder = currentOrder === 'asc' ? 'desc' : 'asc';

      if (key === 'task') {
        th.querySelector('i').className = 'fa fa-sort-alpha-' + newOrder;
      }
      else {
        th.querySelector('i').className = 'fa fa-sort-numeric-' + newOrder;
      }

      th.dataset.order = newOrder;
      sortTableBy(key, newOrder);
    });
  });
</script>
</body>
</html>
